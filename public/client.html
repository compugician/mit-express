<style>
html, body {
  overflow: hidden;
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.21/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>

<script type="text/javascript">
'use strict';
// socket io
// TODO: investigate puredata
var socket = io.connect('http://localhost:3000/');
var dotDiameter, r, g, b, flow, colorIdx;
var lastNumKeyPressed = 0;
var arrowCount = { up: 0, down: 0, left: 0, right: 0 };
var flowVars = {increase : "up", decrease: "down"};

var colors = {
		red 	: { r : 255, g : 0, b : 0 },
		orange	: { r : 255, g : 127, b : 0 },
		yellow 	: { r : 255, g : 255, b : 0 },
		green	: { r : 0, g : 255, b : 0 },
		blue	: { r : 0, g : 0, b : 255 },
		purple	: { r : 139, g : 0, b : 255 },
		black	: { r : 0, g : 0, b : 0 },
		brown	: { r : 165, g : 42, b : 42 }
	};

var colorList = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'black', 'brown'];

var sentData = {
		x: 0,
		y: 0,
		dotDiameter: 0,
		color: {
			r: 0,
			g: 0,
			b: 0,
			a: 0
		},
		colorIdx: 0,
		flow: 0
	};

var map_to_port = { 
	'airbrushPos' : [getMouseX, getMouseY],
	'colorID'	  : getLastNumKey,
	'flow'		  : [partial(getArrowCount, 'up'), partial(getArrowCount, 'down'), 0]
	};
	
var map_source_to_fn = { 
	'mouse_x' : getMouseX,
	'mouse_y' : getMouseY,
	'key'	  : getLastNumKey,
	'up'	  : partial(getArrowCount, 'up'),
	'down'	  : partial(getArrowCount, 'down'),
	'left'	  : partial(getArrowCount, 'left'),
	'right'	  : partial(getArrowCount, 'right')
	};

// canvas script
function setup() {
  createCanvas(window.innerWidth, window.innerHeight);
  noStroke();
  dotDiameter = 20;
  flow = 0;
  colorIdx = 0;
}

// request the configuration on loading
socket.emit('config-request');

socket.on('config-client', function (config) {
	console.log(config);
	if (config == 'config not yet received'){
		return;
	}
	map_to_port['airbrushPos'][0] = updateConfiguration(config.airbrush_x, 'airbrushPos', 'x');
	map_to_port['airbrushPos'][1] = updateConfiguration(config.airbrush_y, 'airbrushPos', 'y');
	map_to_port['colorID'] = updateConfiguration(config.colorID,'colorID');
	map_to_port['flow'][0] = updateConfiguration(config.flow_increase, 'flow', 'increase');
	map_to_port['flow'][1] = updateConfiguration(config.flow_decrease, 'flow', 'decrease');
	flowVars.increase = config.flow_increase;
	flowVars.decrease = config.flow_decrease;
});

function draw() {
	sentData.x = isFunction(map_to_port['airbrushPos'][0]) ? map_to_port['airbrushPos'][0]() : sentData.x;
	sentData.y = isFunction(map_to_port['airbrushPos'][1]) ? map_to_port['airbrushPos'][1]() : sentData.y;
	sentData.colorIdx = Math.floor(isFunction(map_to_port['colorID']) ? map_to_port['colorID']() : sentData.colorIdx) % 8;
	sentData.flow = getFlow();
	
	socket.emit('point', {
		x: sentData.x,
		y: sentData.y,
		dotDiameter: dotDiameter,
		color: {
			r: colors[colorList[sentData.colorIdx % 8]].r,
			g: colors[colorList[sentData.colorIdx % 8]].g,
			b: colors[colorList[sentData.colorIdx % 8]].b,
			a: 255*(sentData.flow % 101)/100
		},
		colorIdx: sentData.colorIdx,
		flow: sentData.flow
	});
}

function keyPressed() {
	if (keyCode == UP_ARROW) {
		arrowCount['up'] += 1;
		return false;
	}
	if (keyCode == DOWN_ARROW) {
		arrowCount['down'] += 1;
		return false;
	}
	if (keyCode == LEFT_ARROW) {
		arrowCount['left'] += 1;
	}
	if (keyCode == RIGHT_ARROW) {
		arrowCount['right'] += 1;
	}
	if (parseInt(key) || key == '0') {
		lastNumKeyPressed = parseInt(key);
		colorIdx = parseInt(key) * 2;
		return false;
	}
	return true;
}

// -----------------------------------------------------------------------------------
function getMouseX(){
	return mouseX + 8;
}

function getMouseY(){
	return mouseY + 8;
}

function getLastNumKey(){
	return lastNumKeyPressed;
}

function getArrowCount(key){
	return arrowCount[key];
}
function isFunction(functionToCheck) {
	var getType = {};
	return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
}

function getFlow() {
	if (isFunction(map_to_port['flow'][0])){
		if (isFunction(map_to_port['flow'][1])){
			return min(100, map_to_port['flow'][0]() - map_to_port['flow'][1]());
		} else {
			return min(100, map_to_port['flow'][0]() - map_to_port['flow'][1]);
		}
	} else {
		if (isFunction(map_to_port['flow'][1])){
			return min(100, map_to_port['flow'][0] - map_to_port['flow'][1]());
		} else {
			return sentData.flow;
		}
	}
}

function partial(func /*, 0..n args */) {
  var args = Array.prototype.slice.call(arguments).splice(1);
  return function() {
    var allArguments = args.concat(Array.prototype.slice.call(arguments));
    return func.apply(this, allArguments);
  };
}

function setCounter(counterName, setVal){
	switch(counterName){
		case ("key"):
			lastNumKeyPressed = setVal;
			break;
		case ("up"):
			arrowCount['up'] = setVal;
			break;
		case ("down"):
			arrowCount['down'] = setVal;
			break;
		case ("left"):
			arrowCount['left'] = setVal;
			break;
		case ("right"):
			arrowCount['right'] = setVal;
			break;
	}
}

function updateConfiguration(updatedElement, targetName, targetPort){
	console.log(targetPort + " target port");
	if (updatedElement == undefined) {
		switch(targetName){
			case('airbrushPos'):
				if (targetPort == 'x'){
					return sentData.x;
				} else {
					return sentData.y;
				}
			case('colorID'):
				return sentData.colorIdx;
			case('flow'):
				if (targetPort == 'increase'){
					setCounter(flowVars.increase, 0);
					setCounter(flowVars.decrease, 0);
					return sentData.flow;

				} else {
					setCounter(flowVars.increase, sentData.flow);
					return 0;
				}
		// .. can put other stuff here later
		}
	}
	return map_source_to_fn[updatedElement]
}
</script>