<style>
html, body {
  overflow: hidden;
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.21/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>

<script type="text/javascript">
'use strict';
// socket io
var socket = io.connect('http://localhost:3000/');
var dotDiameter, r, g, b, flow, colorIdx;
var lastNumKeyPressed;
var arrowCount = { up: 0, down: 0, left: 0, right: 0 };

var data = {
		x: 0,
		y: 0,
		dotDiameter: 0,
		color: {
			r: 0,
			g: 0,
			b: 0,
			a: 0
		},
		colorIdx: 0,
		flow: 0
	};



var map_to_port = { 
	'airbrushPos' : [getMouseX, getMouseY],
	'colorID'	  : [getLastNumKey]
	};
	
var map_source_to_fn = { 
	'mouse_x' : getMouseX,
	'mouse_y' : getMouseY,
	'key'	  : getLastNumKey,
	'up'	  : partial(getArrowCount, 'up'),
	'down'	  : partial(getArrowCount, 'down'),
	'left'	  : partial(getArrowCount, 'left'),
	'right'	  : partial(getArrowCount, 'right')
	};

// canvas script
function setup() {
  createCanvas(window.innerWidth, window.innerHeight);
  noStroke();
  dotDiameter = Math.random() * 15 + 10;
  // TODO correlate this to the colorIdx
  r = Math.random() * 156 + 100;
  g = Math.random() * 156 + 100;
  b = Math.random() * 156 + 100;
  flow = 0;
  colorIdx = 0;
}

socket.on('config-client', function (data) {
	if (data.deleted){
		switch(data.targetName){
			case('airbrushPos'):
				if (data.targetPort == 'x'){
					map_to_port['airbrushPos'][0] = data.x;
				} else {
					map_to_port['airbrushPos'][1] = data.y;
				}
				break;
			case('colorID'):
				map_to_port['colorID'] = data.colorIdx;
				break;
		// .. can put other stuff here later
		}
	}
	else{
		switch(data.targetName){
			case('airbrushPos'):
				if (data.targetPort == 'x'){
					map_to_port['airbrushPos'][0] = map_source_to_fn[data.sourcePort];
				} else {
					map_to_port['airbrushPos'][1] = map_source_to_fn[data.sourcePort];
				}
				break;
			case('colorID'):
				map_to_port['colorID'] = map_source_to_fn[data.sourcePort];
				break;
		}
	}
	
	console.log(map_to_port);
});

function draw() {
	data.x = isFunction(map_to_port['airbrushPos'][0]) ? map_to_port['airbrushPos'][0]() : data.x;
	data.y = isFunction(map_to_port['airbrushPos'][1]) ? map_to_port['airbrushPos'][1]() : data.y;
	data.colorIdx = isFunction(map_to_port['colorID']) ? map_to_port['colorID']() : data.colorIdx;
	
	socket.emit('point', {
		x: data.x,
		y: data.y,
		dotDiameter: dotDiameter,
		color: {
			r: r,
			g: g,
			b: b,
			a: 255//*flow/100
		},
		colorIdx: data.colorIdx,
		flow: 50//flow
	});
}

function mousePressed() {
  dotDiameter = Math.random() * 15 + 10;
  r = Math.random() * 156 + 100;
  g = Math.random() * 156 + 100;
  b = Math.random() * 156 + 100;
}
function keyPressed() {
	if (keyCode === UP_ARROW) {
		arrowCount['up'] += 1;
		//flow+=10;
		//if (flow > 100) flow = 100;
		return false;
	}
	if (keyCode === DOWN_ARROW) {
		arrowCount['down'] += 1;
		//flow-=10;
		//if (flow < 0) flow = 0;
		return false;
	}
	if (keyCode == LEFT_ARROW) {
		arrowCount['left'] += 1;
	}
	if (keyCode == RIGHT_ARROW) {
		arrowCount['right'] += 1;
	}
	if (parseInt(key) || key === '0') {
		lastNumKeyPressed = parseInt(key);
		colorIdx = parseInt(key) * 2;
		return false;
	}
	return true;
}

// -----------------------------------------------------------------------------------
function getMouseX(){
	return mouseX + 8;
}

function getMouseY(){
	return mouseY + 8;
}

function getLastNumKey(){
	return lastNumKeyPressed;
}

function getArrowCount(key){
	console.log(arrowCount);
	return arrowCount[key];
}
function isFunction(functionToCheck) {
	var getType = {};
	return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
}

function partial(func /*, 0..n args */) {
  var args = Array.prototype.slice.call(arguments).splice(1);
  return function() {
    var allArguments = args.concat(Array.prototype.slice.call(arguments));
    return func.apply(this, allArguments);
  };
}
</script>