<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="http://www.jointjs.com/js/vendor/jquery/jquery.min.js"></script>
<script src="http://www.jointjs.com/js/vendor/lodash/lodash.min.js"></script>
<script src="http://www.jointjs.com/js/vendor/backbone/backbone-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
<script src="http://www.jointjs.com/cms/downloads/joint.js"></script>
<link rel="stylesheet" href="http://www.jointjs.com/cms/downloads/joint.css" />

</head>        

<body style = "font-family:verdana">
<div id="paper"></div>
</body>

<script type="text/javascript">

// socket io
var socket = io.connect('http://localhost:3000/');

var graph = new joint.dia.Graph;
var paper = new joint.dia.Paper({ 
	el: $('#paper'), 
	width: 650, 
	height: 650, 
	gridSize: 1, 
	model: graph,
	defaultLink: new joint.dia.Link({
        attrs: { '.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' } }
    }),
	linkPinning: false,
    validateConnection: function(sourceView, sourceMagnet, targetView, targetMagnet) {
        return sourceMagnet != targetMagnet;
    },
	validateEmbedding: function(childView, parentView) {
        return parentView.model instanceof joint.shapes.devs.Coupled;
    }
    
});

var m1 = new joint.shapes.devs.Model({
    position: { x: 50, y: 50 },
    size: { width: 90, height: 90 },
    inPorts: ['increase','decrease'],
    outPorts: ['out'],
    attrs: {
        '.label': { text: 'Color ID', 'ref-x': .5, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    },
	name: 'colorID'
});
graph.addCell(m1);

var mouse = new joint.shapes.devs.Model({
    position: { x: 100, y: 50 },
    size: { width: 90, height: 200 },
    outPorts: ['left click', 'right click', 'middle click', 'scroll wheel'],
    attrs: {
        '.label': { text: 'Mouse', 'ref-x': .4, 'ref-y': .45 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }, 
	name: 'mouse'
});
graph.addCell(mouse);

// rounded edges
_.each([m1, mouse], function(element) {
    element.attr({ '.body': { 'rx': 6, 'ry': 6 }});
});

graph.on('change:source change:target', function(link) {
    var sourcePort = link.get('source').port;
    var sourceId = link.get('source').id;
    var targetPort = link.get('target').port;
    var targetId = link.get('target').id;
	
	var m = [
        'The port <b>' + sourcePort,
        '</b> of element with ID <b>' + sourceId,
        '</b> is connected to port <b>' + targetPort,
        '</b> of elemnt with ID <b>' + targetId + '</b>'
    ].join('');
	
	if (targetPort != undefined && sourcePort != undefined){
		socket.emit('config', {
			sourcePort : link.get('source').port,
			sourceId : link.get('source').id,
			targetPort : link.get('target').port,
			targetId : link.get('target').id,
			deleted : false
		});
		console.log(m)
	}

});

graph.on('remove', function(cell, collection, opt) {
   if (cell.isLink() && cell.get('target').port != undefined) {
		link = cell
		socket.emit('config', {
			sourcePort : link.get('source').port,
			sourceId : link.get('source').id,
			targetPort : link.get('target').port,
			targetId : link.get('target').id,
			deleted : true
		});
		
		console.log("deleted: " + cell.get('target').port); 
   }
})


</script>
</html>